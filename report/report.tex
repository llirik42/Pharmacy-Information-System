\documentclass[a4paper]{article}

\usepackage[a4paper, top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry}
\usepackage[T1, T2A]{fontenc}
\usepackage[fontsize=12pt]{fontsize}

\usepackage[english, russian]{babel}
\usepackage[utf8]{inputenc}

\usepackage{hyperref}
\usepackage{amsthm}
\usepackage{tabularx}
\usepackage{pgfplots}
\usepackage{graphicx}
\usepackage{float}
\usepackage{tikz}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{indentfirst}

\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\hypersetup{pdfpagemode=FullScreen, colorlinks=true, linkcolor=black, urlcolor=cyan}

\newcommand{\dbtable}[1]{\textbf{#1}}
\newcommand{\dbtableref}[1]{\textit{#1}}

\begin{document}
	\thispagestyle{empty}
	
	\input{title_page.tex}
		
	\newpage
		
	\tableofcontents
	
	\pagestyle{plain}
	
	\newpage
	
	\section{Задание}
		Разработать структуру базы данных для информационной системы аптеки и реализовать приложение в архитектуре клиент-сервер, выполняющее операции внесения данных в базу данных, редактирование данных и запросы.
		
		\subsection{Описание предметной области}
			Аптека продает медикаменты и изготавливает их по рецептам. Лекарства могут быть разных типов:
			\begin{enumerate}
				\item Готовые лекарства: таблетки, мази, настойки.
				
				\item Изготовляемые аптекой: микстуры, мази, растворы, настойки, порошки.
			\end{enumerate}
			Различие в типах лекарств отражается в различном наборе атрибутов, их характеризующих. Микстуры и порошки изготавливаются только для внутреннего применения, растворы для наружного, внутреннего применения и для смешивания с другими лекарствами и мази только для наружного применения. Лекарство различны также по способу приготовления и по времени приготовления. Порошки и мази изготавливаются смешиванием различных компонент. При изготовлении растворов и микстур ингредиенты не только смешивают, но и отстаивают с последующей фильтрацией лекарства, что увеличивает время изготовления.
			
			В аптеке существует справочник технологий приготовления различных лекарств. В нем указываются: идентификационный номер технологии, название лекарства и сам способ приготовления. На складе на все медикаменты устанавливается критическая норма, т.е. когда какого-либо вещества на складе меньше критической нормы, то составляются заявки на данные вещества и их в срочном порядке привозят с оптовых складов медикаментов.
			
			Для изготовления аптекой лекарства, больной должен принести рецепт от лечащего врача. В рецепте должно быть указано: ФИО, подпись и печать врача, ФИО, возраст и диагноз пациента, также количество лекарства и способ применения. Больной отдает рецепт регистратору, он принимает заказ и смотрит, есть ли компоненты заказываемого лекарства. Если не все компоненты имеются в наличии, то делает заявки на оптовые склады лекарств и фиксирует ФИО, телефон и адрес необслуженного покупателя, чтобы сообщить ему, когда доставят нужные компоненты. Такой больной пополняет справочник заказов - это те заказы, которые находятся в процессе приготовления, с пометкой, что не все компоненты есть для заказа. Если все компоненты имеются, то они резервируются для лекарства больного. Покупатель выплачивает цену лекарства, ему возвращается рецепт с пометкой о времени изготовления. Больной также пополняет справочник заказов в производстве. В назначенное время больной приходит и по тому же рецепту получает готовое лекарство. Такой больной пополняет список отданных заказов.
			
			Ведется статистика по объемам используемых медикаментов. Через определенный промежуток времени производится инвентаризация склада. Это делается для того, чтобы определить, есть ли лекарства с критической нормой, или вышел срок хранения или недостача.	
	\section{Схема базы данных}		
		\begin{figure}[H]
			\centering
			\def\svgwidth{\columnwidth}
			\input{scheme.pdf_tex}
			\caption{\small Графическая схема базы данных}
		\end{figure}
			
		\subsection{Описание таблиц}
			\begin{itemize}
				\item \dbtable{administration\_routes} --- способы применения лекарств (идентификатор способа, название);
					
				\item \dbtable{drug\_types} --- типы лекарств (идентификатор типа, название);
					
				\item \dbtable{drug\_types\_administration\_routes} --- соответствие между типами лекарств и способами их применения (идентификатор типа, идентификатор способа);
					
				\item \dbtable{customers} --- клиенты аптеки (идентификатор клиента, ФИО, номер телефона, адрес);
					
				\item \dbtable{doctors} --- врачи, которые выписывают рецепты для больных (идентификатор врача, ФИО);
					
				\item \dbtable{patients} --- пациенты, то есть те, на кого выписывают рецепты (идентификатор пациента, ФИО, дата рождения);
					
				\item \dbtable{suppliers} --- поставщики лекарств в аптеку (идентификатор поставщика, название, номер телефона);
					
				\item \dbtable{prescriptions} --- рецепты, выписанные больным врачами (идентификатор рецепта, диагноз, идентификатор пациента, идентификатор врача, дата);
					
				\item \dbtable{mixture\_types} --- типы микстур (идентификатор типа, название);
					
				\item \dbtable{drugs} --- лекарства (идентификатор лекарства, название, стоимость, срок годности, критическая норма, идентификатор типа --- из \dbtableref{drug\_types}, описание);
					
				\item \dbtable{mixtures} --- микстуры (идентификатор лекарства --- из \dbtableref{drugs}, растворитель, идентификатор типа микстуры --- из \dbtableref{mixture\_types});
					
				\item \dbtable{pills} --- таблетки (идентификатор лекарства --- из \dbtableref{drugs}, масса одной таблетки, масса пачки таблеток);
					
				\item \dbtable{powders} --- порошки (идентификатор лекарства --- из \dbtableref{drugs}, составной порошок или нет);
					
				\item \dbtable{salves} --- мази (идентификатор лекарства --- из \dbtableref{drugs}, действующее вещество);
					
				\item \dbtable{solutions} --- растворы (идентификатор лекарства --- из \dbtableref{drugs}, концентрация);
					
				\item \dbtable{tinctures} --- настойки (идентификатор лекарства --- из \dbtableref{drugs}, материал);
					
				\item \dbtable{prescriptions\_content} --- состав рецептов (идентификатор рецепта --- из \dbtableref{prescriptions}, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства, способ применения --- из \dbtableref{administration\_routes});
					
				\item \dbtable{storage\_items} --- позиции лекарств на складе (идентификатор позиции, идентификатор лекарства --- из \dbtableref{drugs}, текущее количество лекарства в позиции на складе, исходное количество лекарства в позиции на складе; дата получения);
					
				\item \dbtable{supplies} --- поставки лекарств от поставщиков (идентификатор поставки, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства, общая стоимость, идентификатор поставщика --- из \dbtableref{suppliers}, дата поставки);
					
				\item \dbtable{technologies} --- справочник технологий приготовления лекарств (идентификатор технологии, идентификатор лекарства --- из \dbtableref{drugs}, время приготовления, количество приготовляемого лекарства, инструкция);
					
				\item \dbtable{technology\_components} --- лекарства, требуемые для приготовления лекарств по технологиям (идентификатор технологии --- из \dbtableref{technologies}, идентификатор лекарства, требуемого для технологии --- из \dbtableref{drugs}, количество данного лекарства, требуемого для технологии);
					
				\item \dbtable{orders} --- заказы (идентификатор заказа, идентификатор рецепта --- из \dbtableref{prescriptions}, дата регистрации, назначенная дата получения заказа, реальная дата получения заказа, оплачен ли заказ, идентификатор клиента --- из \dbtableref{customers});
					
				\item \dbtable{orders\_waiting\_drug\_supplies} --- поставки каких лекарств нужны для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства);
					
				\item \dbtable{reserved\_drugs} --- какие лекарства со склада зарезервированы для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор позиции склада --- из \dbtableref{storage\_items}, количество лекарства);
					
				\item \dbtable{production} --- приготовление лекарства для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор технологии приготовления лекарства --- из \dbtableref{technologies}, количество процессов приготовления лекарства, дата начала готовки, дата завершения готовки).
			\end{itemize}
		\subsection{Создание таблиц}
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={SQL-скрипт для создания таблиц базы данных}
			]{../scheme.sql}
		\subsection{Ограничения по поддержанию целостности}
			\begin{itemize}
				\item Любой посетитель аптеки должен иметь рабочий российский номер телефона и корректный российский адрес проживания (столбцы \dbtableref{phone\_number} и \dbtableref{address} в таблице \dbtable{customers}); 
				
				\item Стоимость любого лекарство должна быть выше чем суммарная стоимость компонент для изготовления этого лекарства по всем технологиями (таблицы \dbtable{technologies} и \dbtable{technology\_components}) его приготовления; Это должно проверяться триггером при добавлении новой записи в таблицу \dbtable{technology\_components};
				
				\item Для любой технологии должна быть хотя бы одна запись в таблице требуемых для неё компонентов;
				
				\item Если для изготовления лекарства существует какая-то технология, то это лекарство должно иметь изготовляемый тип (столбец \dbtableref{is\_cookable} в таблице \dbtable{drug\_types}). Это должно проверяться триггером при добавлении новой записи в таблицу \dbtable{technologies};
				
				\item Любой поставщик должен иметь рабочий российский номер телефона \newline (столбец \dbtableref{phone\_number} в таблице \dbtable{suppliers});
				
				\item Способ применения лекарства в рецепте (столбец \dbtableref{administration\_route\_id} в таблице \dbtable{prescriptions\_content}) должен быть допустим для этого лекарства в соответствии с его типом (эта информация хранится в таблице \dbtable{drug\_types\_administration\_routes}); Это должно проверяться триггером при добавлении новой записи в таблицу \newline \dbtable{prescriptions\_content};
				
				\item Любой пациент должен иметь дату рождения, которая не больше чем дата добавления пациента в таблицу (столбец \dbtableref{birthday} в таблице \dbtableref{patients}); Это должно проверяться при добавлении новой записи в таблицу \dbtable{patients};
				
				\item Дата регистрации любого заказа должна быть больше даты выписки рецепта, соответствующего этому заказу (столбец \dbtableref{registration\_date} в таблице \dbtable{orders} и столбец \dbtableref{date} в таблице \dbtable{prescriptions}); Это должно проверяться триггером при добавлении новой записи в таблицу \dbtable{orders};
				
				\item Если какой-нибудь заказ забрали, то он обязательно оплачен (если в таблице \dbtable{orders} столбец \dbtableref{obtaining\_date} не $null$, то столбец \dbtableref{is\_paid} должен быть $True$). Это должно проверяться триггером при изменении полей \dbtableref{obtaining\_date} и \dbtableref{is\_paid} любой записи таблицы \dbtable{orders};
				
				\item Если какой-нибудь заказ был забран, то у него должна быть назначенная дата и наоборот (если столбец \dbtableref{obtaining\_date} не $null$, то столбец \dbtableref{appointed\_date} не $null$ в таблице \dbtable{orders} и наоборот); Это должно проверяться триггером при изменении полей \dbtableref{obtaining\_date} и \dbtableref{appointed\_date} любой записи таблицы \dbtable{orders};
				
				\item Дата регистрации любого заказа любого заказа должна быть не больше назначенной даты его получения, что в свою очередь должно быть не больше реальной даты его получения (столбцы \dbtableref{registration\_date}, \dbtableref{appointed\_date} и \dbtableref{obtaining\_date} в таблице \dbtable{orders}); Это должно проверяться при изменении полей \dbtableref{appointed\_date} и \dbtableref{obtaining\_date} любой записи таблицы \dbtableref{orders};
				
				\item Никакой заказ не должен ждать поставки лекарств, которые для него не требуются, как и для любого заказа не должно изготовляться лекарств, которые для него не требуются. Это должно проверяться триггером при добавлении новой записи в таблицы \dbtable{production} и \dbtable{orders\_waiting\_drug\_supplies};
					
				\item Дата получения поставки на склад должна быть больше чем текущая дата (столбец \dbtableref{receipt\_date} в таблице \dbtable{storage\_items}); Это должно проверяться триггером при добавлении новой записи в таблицу \dbtable{storage\_items};
				
				\item Дата начала изготовления лекарства должна быть меньше даты окончания его изготовления (столбцы \dbtableref{start\_date} и \dbtableref{end\_date} в таблице \dbtable{production}). Это должно проверяться триггером при изменении поля \dbtableref{end\_date} любой записи таблицы \dbtable{production};
				
				\item Если завершилось приготовление лекарства, то для этой партии лекарства должна добавиться запись на складе. Это должно осуществляться  триггером при изменении значения поля \dbtableref{end\_date} любой записи таблицы \dbtable{production};
			
				\item Если для какого-то заказа было зарезервировано некоторое лекарство в некотором количестве, то количество доступного лекарства на складе из этой партии должно уменьшиться на соответствующее количество. Это должно осуществляться триггером при добавлении новой записи в таблицу \dbtable{reserved\_drugs};		
			\end{itemize}
	\newpage
	\section{Реализация запросов к базы данных}
		\begin{enumerate}			
			\item Получить сведения о покупателях, которые не пришли забрать свой заказ в назначенное им время и общее их число.
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
			]{../queries/1.sql}
			
			\item Получить перечень и общее число покупателей, которые ждут прибытия на склад нужных им медикаментов в целом и по указанной категории медикаментов.
			
			\item Получить перечень десяти наиболее часто используемых медикаментов в целом и указанной категории медикаментов.
			
			\item  Получить какой объем указанных веществ использован за указанный период.
			
			\item Получить перечень и общее число покупателей, заказывавших определенное лекарство или определенные типы лекарств за данный период.
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={5.1}
			]{../queries/5-1.sql}
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={5.2}
			]{../queries/5-2.sql}
			
			\item Получить перечень и типы лекарств, достигших своей критической нормы или закончившихся.
			
			\item Получить перечень лекарств с минимальным запасом на складе в целом и по указанной категории медикаментов.
			
			\item Получить полный перечень и общее число заказов находящихся в производстве.
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
			]{../queries/8.sql}
			
			\item Получить полный перечень и общее число препаратов требующихся для заказов, находящихся в производстве.
			
			\item Получить все технологии приготовления лекарств указанных типов, конкретных лекарств, лекарств, находящихся в справочнике заказов в производстве.
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={10.1}
			]{../queries/10-1.sql}
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={10.2}
			]{../queries/10-2.sql}
			
			\item Получить сведения о ценах на указанное лекарство в готовом виде, об объеме и ценах на все компоненты, требующиеся для этого лекарства.
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
			]{../queries/11.sql}
			
			\item Получить сведения о наиболее часто делающих заказы клиентах на медикаменты определенного типа, на конкретные медикаменты.
			
			\item Получить сведения о конкретном лекарстве (его тип, способ приготовления, названия всех компонент, цены, его количество на складе).
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={13.1}
			]{../queries/13-1.sql}
			
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={13.2}
			]{../queries/13-2.sql}
		\end{enumerate}
\end{document}
