\documentclass[a4paper]{article}

\usepackage[a4paper, top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry}
\usepackage[T1, T2A]{fontenc}
\usepackage[fontsize=12pt]{fontsize}

\usepackage[english, russian]{babel}
\usepackage[utf8]{inputenc}

\usepackage{hyperref}
\usepackage{amsthm}
\usepackage{tabularx}
\usepackage{pgfplots}
\usepackage{graphicx}
\usepackage{float}
\usepackage{tikz}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{indentfirst}

\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\hypersetup{pdfpagemode=FullScreen, colorlinks=true, linkcolor=black, urlcolor=cyan}

\newcommand{\dbtable}[1]{\textbf{#1}}
\newcommand{\dbtableref}[1]{\textit{#1}}

\begin{document}
	\thispagestyle{empty}
	
	\input{title_page.tex}
		
	\newpage
		
	\tableofcontents
	
	\pagestyle{plain}
	
	\newpage
	
	\section{Задание}
		Разработать структуру базы данных для информационной системы аптеки и реализовать приложение в архитектуре клиент-сервер, выполняющее операции внесения данных в базу данных, редактирование данных и запросы.
		
		\subsection{Описание предметной области}
			Аптека продает медикаменты и изготавливает их по рецептам. Лекарства могут быть разных типов:
			\begin{enumerate}
				\item Готовые лекарства: таблетки, мази, настойки.
				
				\item Изготовляемые аптекой: микстуры, мази, растворы, настойки, порошки.
			\end{enumerate}
			Различие в типах лекарств отражается в различном наборе атрибутов, их характеризующих. Микстуры и порошки изготавливаются только для внутреннего применения, растворы для наружного, внутреннего применения и для смешивания с другими лекарствами и мази только для наружного применения. Лекарство различны также по способу приготовления и по времени приготовления. Порошки и мази изготавливаются смешиванием различных компонент. При изготовлении растворов и микстур ингредиенты не только смешивают, но и отстаивают с последующей фильтрацией лекарства, что увеличивает время изготовления.
			
			В аптеке существует справочник технологий приготовления различных лекарств. В нем указываются: идентификационный номер технологии, название лекарства и сам способ приготовления. На складе на все медикаменты устанавливается критическая норма, т.е. когда какого-либо вещества на складе меньше критической нормы, то составляются заявки на данные вещества и их в срочном порядке привозят с оптовых складов медикаментов.
			
			Для изготовления аптекой лекарства, больной должен принести рецепт от лечащего врача. В рецепте должно быть указано: ФИО, подпись и печать врача, ФИО, возраст и диагноз пациента, также количество лекарства и способ применения. Больной отдает рецепт регистратору, он принимает заказ и смотрит, есть ли компоненты заказываемого лекарства. Если не все компоненты имеются в наличии, то делает заявки на оптовые склады лекарств и фиксирует ФИО, телефон и адрес необслуженного покупателя, чтобы сообщить ему, когда доставят нужные компоненты. Такой больной пополняет справочник заказов - это те заказы, которые находятся в процессе приготовления, с пометкой, что не все компоненты есть для заказа. Если все компоненты имеются, то они резервируются для лекарства больного. Покупатель выплачивает цену лекарства, ему возвращается рецепт с пометкой о времени изготовления. Больной также пополняет справочник заказов в производстве. В назначенное время больной приходит и по тому же рецепту получает готовое лекарство. Такой больной пополняет список отданных заказов.
			
			Ведется статистика по объемам используемых медикаментов. Через определенный промежуток времени производится инвентаризация склада. Это делается для того, чтобы определить, есть ли лекарства с критической нормой, или вышел срок хранения или недостача.	
	\section{Схема базы данных}		
		\begin{figure}[H]
			\centering
			\def\svgwidth{\columnwidth}
			\input{scheme.pdf_tex}
			\caption{\small Графическая схема базы данных}
		\end{figure}
			
		\subsection{Описание таблиц}
			\begin{itemize}
				\item \dbtable{administration\_routes} --- способы применения лекарств (идентификатор способа, описание);
				
				\item \dbtable{drug\_types} --- типы лекарств (идентификатор типа, название, являются ли приготовляемыми лекарства данного типа);
				
				\item \dbtable{mixture\_types} --- типы микстур (идентификатор типа, название);
				
				\item \dbtable{patients} --- пациенты, то есть те, на кого выписывают рецепты (идентификатор пациента, ФИО, дата рождения);
				
				\item \dbtable{doctors} --- врачи, которые выписывают рецепты для больных (идентификатор врача, ФИО);
				
				\item \dbtable{customers} --- клиенты аптеки (идентификатор клиента, ФИО, номер телефона, адрес);
				
				\item \dbtable{suppliers} --- поставщики лекарств в аптеку (идентификатор поставщика, название, номер телефона);
				
				\item \dbtable{drugs} --- лекарства (идентификатор лекарства, название, стоимость, срок годности в часах, критическая норма, идентификатор типа --- из \dbtableref{drug\_types}, описание);
				
				\item \dbtable{mixtures} --- микстуры (идентификатор лекарства --- из \dbtableref{drugs}, растворитель, идентификатор типа микстуры --- из \dbtableref{mixture\_types});
				
				\item \dbtable{pills} --- таблетки (идентификатор лекарства --- из \dbtableref{drugs}, масса одной таблетки, количество таблеток в упаковке);
				
				\item \dbtable{powders} --- порошки (идентификатор лекарства --- из \dbtableref{drugs}, составной порошок или нет);
					
				\item \dbtable{salves} --- мази (идентификатор лекарства --- из \dbtableref{drugs}, действующее вещество);
				
				\item \dbtable{solutions} --- растворы (идентификатор лекарства --- из \dbtableref{drugs}, концентрация);
				
				\item \dbtable{tinctures} --- настойки (идентификатор лекарства --- из \dbtableref{drugs}, материал);
				
				\item \dbtable{drug\_types\_administration\_routes} --- соответствие между типами лекарств и способами их применения (идентификатор типа, идентификатор способа);
						
				\item \dbtable{prescriptions} --- рецепты, выписанные больным врачами (идентификатор рецепта, диагноз, идентификатор пациента, идентификатор врача, дата);
				
				\item \dbtable{orders} --- заказы (идентификатор заказа, идентификатор рецепта --- из \dbtableref{prescriptions}, дата и время регистрации, назначенные дата и время получения заказа, реальные дата и время получения заказа, оплачен ли заказ, идентификатор клиента --- из \dbtableref{customers});
				
				\item \dbtable{prescriptions\_content} --- состав рецептов (идентификатор рецепта --- из \dbtableref{prescriptions}, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства, способ применения --- из \dbtableref{administration\_routes});
				
				\item \dbtable{storage\_items} --- позиции лекарств на складе (идентификатор позиции, идентификатор лекарства --- из \dbtableref{drugs}, доступное количество лекарства в позиции на складе, исходное количество лекарства в позиции на складе; дата и время получения на складе);
				
				\item \dbtable{supplies} --- поставки лекарств от поставщиков (идентификатор поставки, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства, общая стоимость, назначенные дата и время поставки, реальные дата и время поставки, идентификатор поставщика --- из \dbtableref{suppliers});
					
				\item \dbtable{technologies} --- справочник технологий приготовления лекарств (идентификатор технологии, идентификатор лекарства --- из \dbtableref{drugs}, время приготовления, количество приготовляемого лекарства, инструкция);
					
				\item \dbtable{technology\_components} --- лекарства, требуемые для приготовления лекарств по технологиям (идентификатор технологии --- из \dbtableref{technologies}, идентификатор лекарства, требуемого для технологии --- из \dbtableref{drugs}, количество данного лекарства, требуемого для технологии);
								
				\item \dbtable{production} --- приготовление лекарства для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор технологии приготовления лекарства --- из \dbtableref{technologies}, количество процессов приготовления лекарства, дата и время начала готовки, дата и время завершения готовки).
								
				\item \dbtable{orders\_waiting\_drug\_supplies} --- поставки каких лекарств нужны для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор лекарства --- из \dbtableref{drugs}, количество лекарства);
					
				\item \dbtable{reserved\_drugs} --- какие лекарства со склада зарезервированы для заказов (идентификатор заказа --- из \dbtableref{orders}, идентификатор позиции склада --- из \dbtableref{storage\_items}, количество лекарства);
			\end{itemize}
		\subsection{Создание таблиц}
			\lstinputlisting[
				language=SQL,
				backgroundcolor=\color{backcolour},
				basicstyle=\scriptsize,
				caption={SQL-скрипт для создания таблиц базы данных}
			]{../db/scheme.sql}
		\subsection{Ограничения по поддержанию целостности}
			\begin{itemize}
				\item Любой посетитель аптеки должен иметь рабочий российский номер телефона и корректный российский адрес проживания (столбцы \dbtableref{phone\_number} и \dbtableref{address} в таблице \dbtable{customers}); 
				
				\item Стоимость любого лекарство должна быть выше чем суммарная стоимость компонент для изготовления этого лекарства по всем технологиями (таблицы \dbtable{technologies} и \dbtable{technology\_components}) его приготовления;
				
				\item Для любой технологии должна быть хотя бы одна запись в таблице требуемых для неё компонентов;
				
				\item Если для изготовления лекарства существует какая-то технология, то это лекарство должно иметь изготовляемый тип (столбец \dbtableref{cookable} в таблице \dbtable{drug\_types}).
				
				\item Любой поставщик должен иметь рабочий российский номер телефона \newline (столбец \dbtableref{phone\_number} в таблице \dbtable{suppliers});
				
				\item Способ применения лекарства в рецепте (столбец \dbtableref{administration\_route\_id} в таблице \dbtable{prescriptions\_content}) должен быть допустим для этого лекарства в соответствии с его типом (эта информация хранится в таблице \dbtable{drug\_types\_administration\_routes});
				
				\item Любой пациент должен иметь дату рождения, которая не больше чем дата добавления пациента в таблицу (столбец \dbtableref{birthday} в таблице \dbtableref{patients});
				
				\item Дата регистрации любого заказа должна быть больше даты выписки рецепта, соответствующего этому заказу (столбец \dbtableref{registration\_datetime} в таблице \dbtable{orders} и столбец \dbtableref{date} в таблице \dbtable{prescriptions});
				
				\item Если какой-нибудь заказ забрали, то он обязательно оплачен (если в таблице \dbtable{orders} столбец \dbtableref{obtaining\_datetime} не $null$, то столбец \dbtableref{paid} должен быть $True$);
				
				\item Если какой-нибудь заказ был забран, то у него должна быть назначенная дата и наоборот (если столбец \dbtableref{obtaining\_datetime} не $null$, то столбец \dbtableref{appointed\_datetime} не $null$ в таблице \dbtable{orders} и наоборот);
				
				\item Дата регистрации любого заказа должна быть не больше назначенной даты его получения, что в свою очередь должно быть не больше реальной даты его получения (столбцы \dbtableref{registration\_datetime}, \dbtableref{appointed\_datetime} и \dbtableref{obtaining\_datetime} в таблице \dbtable{orders}); Это должно проверяться при изменении полей \dbtableref{appointed\_datetime} и \dbtableref{obtaining\_datetime} любой записи таблицы \dbtableref{orders};
				
				\item Никакой заказ не должен ждать поставки лекарств, которые для него не требуются, как и для любого заказа не должно изготовляться лекарств, которые для него не требуются;
					
				\item Дата получения поставки на склад должна быть больше чем текущая дата (столбец \dbtableref{receipt\_datetime} в таблице \dbtable{storage\_items});
				
				\item Дата начала изготовления лекарства должна быть меньше даты окончания его изготовления (столбцы \dbtableref{start\_datetime} и \dbtableref{end\_datetime} в таблице \dbtable{production});
				
				\item Если завершилось приготовление лекарства, то для этой партии лекарства должна добавиться запись на складе;
			
				\item Если для какого-то заказа было зарезервировано некоторое лекарство в некотором количестве, то количество доступного лекарства на складе из этой партии должно уменьшиться на соответствующее количество.
			\end{itemize}
	\newpage
	\section{Реализация запросов к базы данных}
		\begin{enumerate}			
			\item Получить сведения о покупателях, которые не пришли забрать свой заказ в назначенное им время и общее их число.
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Сведения о покупателях}
				]{../queries/1-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число покупателей}
				]{../queries/1-2.sql}

			\item Получить перечень и общее число покупателей, которые ждут прибытия на склад нужных им медикаментов в целом и по указанной категории медикаментов.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень покупателей (в целом)}
				]{../queries/2-1.sql}
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число покупателей (в целом)}
				]{../queries/2-2.sql}
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень покупателей (по указанной категории)},
				]{../queries/2-3.sql}
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число покупателей (по указанной категории)}
				]{../queries/2-4.sql}
			
			\item Получить перечень десяти наиболее часто используемых медикаментов в целом и указанной категории медикаментов.
			
			\item  Получить какой объем указанных веществ использован за указанный период.
			
			\item Получить перечень и общее число покупателей, заказывавших определенное лекарство или определенные типы лекарств за данный период.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень покупателей, заказавших определённое лекарство за данный период}
				]{../queries/5-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число покупателей, заказавших определённое лекарство за данный период}
				]{../queries/5-2.sql}
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень покупателей, заказавших лекарство определённого типа за данный период}
				]{../queries/5-3.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число покупателей, заказавших лекарство определённого типа за данный период}
				]{../queries/5-4.sql}
			
			\item Получить перечень и типы лекарств, достигших своей критической нормы или закончившихся.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень лекарств}
				]{../queries/6-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Типы лекарств}
				]{../queries/6-2.sql}
			
			\item Получить перечень лекарств с минимальным запасом на складе в целом и по указанной категории медикаментов.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={В целом}
				]{../queries/7-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={По указанной категории медикаментов}
				]{../queries/7-2.sql}
			
			\item Получить полный перечень и общее число заказов находящихся в производстве.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Полный перечень заказов}
				]{../queries/8-1.sql}
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число заказов}
				]{../queries/8-1.sql}
			
			\item Получить полный перечень и общее число препаратов требующихся для заказов, находящихся в производстве.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Полный перечень препаратов}
				]{../queries/9-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общее число препаратов}
				]{../queries/9-2.sql}
			
			\item Получить все технологии приготовления лекарств указанных типов, конкретных лекарств, лекарств, находящихся в справочнике заказов в производстве.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Конкретных лекарств}
				]{../queries/10-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Лекарств данного типа}
				]{../queries/10-2.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Лекарств в справочнике заказов в производстве}
				]{../queries/10-3.sql}
			
			\item Получить сведения о ценах на указанное лекарство в готовом виде, об объеме и ценах на все компоненты, требующиеся для этого лекарства.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
				]{../queries/11.sql}
			
			\item Получить сведения о наиболее часто делающих заказы клиентах на медикаменты определенного типа, на конкретные медикаменты.
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={На определённый тип лекарств},
				]{../queries/12-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={На конкретные медикаменты}
				]{../queries/12-2.sql}
			
			\item Получить сведения о конкретном лекарстве (его тип, способ приготовления, названия всех компонент, цены, его количество на складе).
			
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Общие сведения о лекарстве}
				]{../queries/13-1.sql}
				
				\lstinputlisting[
					language=SQL,
					backgroundcolor=\color{backcolour},
					basicstyle=\scriptsize,
					caption={Перечень технологий приготовления лекарства}
				]{../queries/13-2.sql}
		\end{enumerate}
\end{document}
